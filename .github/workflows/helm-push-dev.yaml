name: Helm package dev and push to ghcr.io

on:
  push:
   branches-ignore: [ "main" ]
   paths:
      - "helm_chart/**"
      
jobs:
  package-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Package the Helm chart and push to Artifact Registry
      run: |
        set -euo pipefail

        # Create a safe branch name suffix for the dev version
        SAFE_REF_NAME=$(echo '${{ github.ref_name }}' | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:upper:]' '[:lower:]')
        
        # Get the current version and append dev suffix
        CURRENT_VERSION=$(grep '^version:' helm_chart/Chart.yaml | awk '{print $2}')
        DEV_VERSION="${CURRENT_VERSION}-dev-${SAFE_REF_NAME}"
        
        # Update Chart.yaml with the dev version
        sed -i "s/^version: .*/version: ${DEV_VERSION}/" helm_chart/Chart.yaml

        # Helm packages the chart as {chart-name}-{version}.tgz
        helm package helm_chart --destination ./helm_chart/dist

        # Push the chart (helm push automatically uses the version from Chart.yaml)
        helm push ./helm_chart/dist/local-storage-exporter-*.tgz oci://ghcr.io/prokube/dev/helm